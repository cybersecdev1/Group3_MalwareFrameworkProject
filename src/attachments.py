# Group3 - attachments.py
# The code was taken and modified from the attachment section of the following: https://ecederstrand.github.io/exchangelib/#attachments

import os
from exchangelib import Account, Message, Mailbox, FileAttachment, DELEGATE, Credentials, Configuration, ItemAttachment
from exchangelib.protocol import BaseProtocol, NoVerifyHTTPAdapter
import urllib3

def scrap_attachment(email):
	for attachment in email.attachments:
		if isinstance(attachment, FileAttachment):
			local_path = os.path.join('attachments', attachment.name)
			file = open(local_path, 'wb')
			file.write(attachment.content)
			print("Attachmetn saved")
		elif isinstance(attachment, ItemAttachment):
			if isinstance(attachment.item, Message):
				print(attachment.item.subject, attachment.item.body)

if __name__ =="__main__":
	user_name=input("Enter user account name: ")
	urllib3.disable_warnings()
	BaseProtocol.HTTP_ADAPTER_CLS = NoVerifyHTTPAdapter

	cred = Credentials(username='groupthree\\{}'.format(user_name), password='Passw0rd!')
	config = Configuration(server='mail.groupthree.local', credentials=cred)
	user_account = Account(primary_smtp_address='{}@groupthree.local'.format(user_name), credentials=cred, autodiscover=False, config=config, access_type=DELEGATE)

	[scrap_attachment(mail) for mail in user_account.inbox.all()]