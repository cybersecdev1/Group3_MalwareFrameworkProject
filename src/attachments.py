# Group3 - attachments.py
# The code was taken and modified from the attachment section of the following: https://ecederstrand.github.io/exchangelib/#attachments

import os
from exchangelib import Account, Message, Mailbox, FileAttachment, DELEGATE, Credentials, Configuration, ItemAttachment
from exchangelib.protocol import BaseProtocol, NoVerifyHTTPAdapter

import urllib3
from os import listdir
from os.path import isfile, join
from datetime import datetime
from analysis import full_analysis, analyze_vba

def scrap_attachment(email, dir_name):
	for index, attachment in enumerate(email.attachments):
		if isinstance(attachment, FileAttachment):
			local_path = os.path.join(dir_name, attachment.name)
			file = open(local_path, 'wb')
			file.write(attachment.content)
		elif isinstance(attachment, ItemAttachment):
			if isinstance(attachment.item, Message):
				print(attachment.item.subject, attachment.item.body)

def check_malware_in_file(location):
	onlyfiles = [ f for f in listdir(location) if isfile(join(location, f))]
	for file in onlyfiles:
		full_analysis(f'{location}\\{file}')
		analyze_vba(f'{location}\\{file}')


def parse_attachment_main():
	user_name=input("Enter user account name: ")
	urllib3.disable_warnings()
	BaseProtocol.HTTP_ADAPTER_CLS = NoVerifyHTTPAdapter
	if 'user' in user_name:
		password = 'Junk@6204'
	else:
		password = 'Passw0rd!'
	cred = Credentials(username='groupthree\\{}'.format(user_name), password=password)
	config = Configuration(server='mail.groupthree.local', credentials=cred)
	user_account = Account(primary_smtp_address='{}@groupthree.local'.format(user_name), credentials=cred, autodiscover=False, config=config, access_type=DELEGATE)
	dir_name=f'attachments\\{str(datetime.now())}'
	os.makedirs(dir_name)
	[scrap_attachment(mail, dir_name) for mail in user_account.inbox.all()]
	check_malware_in_file(dir_name)